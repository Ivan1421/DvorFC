name: Deploy Telegram Bot

on:
  workflow_dispatch:  # –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫
  schedule:
    - cron: '0 */2 * * *'  # –ó–∞–ø—É—Å–∫–∞—Ç—å –∫–∞–∂–¥—ã–µ 2 —á–∞—Å–∞

jobs:
  deploy-bot:
    runs-on: ubuntu-latest
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: üêç Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: üì¶ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install python-telegram-bot==20.7
    
    - name: üîß Configure Git
      run: |
        git config --global user.email "github-actions@github.com"
        git config --global user.name "GitHub Actions"
    
    - name: ü§ñ Run Telegram Bot
      env:
        TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
        ADMIN_ID: ${{ secrets.ADMIN_ID }}
      run: |
        echo "üöÄ –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞..."
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –±–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç
        timeout 10m python bot.py || echo "–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω"
    
    - name: üíæ –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ
      run: |
        echo "üìÅ –°–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤:"
        ls -la
        
        if [ -f "players_data.json" ]; then
          echo "‚úÖ players_data.json —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
          echo "üìä –°–æ–¥–µ—Ä–∂–∏–º–æ–µ players_data.json:"
          cat players_data.json | head -20
        fi
        
        if [ -f "stats.js" ]; then
          echo "‚úÖ stats.js —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
          echo "üìä –ü–µ—Ä–≤—ã–µ 10 —Å—Ç—Ä–æ–∫ stats.js:"
          head -20 stats.js
        fi
    
    - name: üì§ Commit and push changes
      run: |
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
        git status
        
        # –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Ñ–∞–π–ª—ã —Å –¥–∞–Ω–Ω—ã–º–∏
        git add players_data.json stats.js || echo "–§–∞–π–ª—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"
        
        # –ö–æ–º–º–∏—Ç–∏–º –µ—Å–ª–∏ –µ—Å—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
        if ! git diff --cached --quiet; then
          git commit -m "ü§ñ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –æ—Ç $(date '+%d.%m.%Y %H:%M')"
          git push
          echo "‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏—è –∑–∞–∫–æ–º–º–∏—á–µ–Ω—ã –∏ –∑–∞–ø—É—â–µ–Ω—ã"
        else
          echo "üì≠ –ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è –∫–æ–º–º–∏—Ç–∞"
        fi
