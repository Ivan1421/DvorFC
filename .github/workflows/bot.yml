name: Update Stats

on:
  workflow_dispatch:  # –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫
  schedule:
    - cron: '*/30 * * * *'  # –ö–∞–∂–¥—ã–µ 30 –º–∏–Ω—É—Ç

jobs:
  update-stats:
    runs-on: ubuntu-latest
    
    steps:
    - name: üì• Checkout repository
      uses: actions/checkout@v3
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: üêç Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: üì¶ Install dependencies
      run: |
        pip install python-telegram-bot==20.7
    
    - name: üîß Configure Git
      run: |
        git config --global user.email "github-actions@github.com"
        git config --global user.name "GitHub Actions"
    
    - name: üöÄ Run bot once to update data
      env:
        TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
        ADMIN_ID: ${{ secrets.ADMIN_ID }}
      run: |
        echo "–ó–∞–ø—É—Å–∫ –±–æ—Ç–∞ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö..."
        # –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç –Ω–∞ 30 —Å–µ–∫—É–Ω–¥
        timeout 30 python bot.py || echo "–ë–æ—Ç –∑–∞–≤–µ—Ä—à–∏–ª —Ä–∞–±–æ—Ç—É"
    
    - name: üì§ Commit and push changes
      run: |
        echo "–ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è..."
        git status
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ñ–∞–π–ª—ã —Å—É—â–µ—Å—Ç–≤—É—é—Ç
        if [ -f "players_data.json" ]; then
          echo "‚úÖ players_data.json —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
        else
          echo "‚ùå players_data.json –Ω–µ —Å–æ–∑–¥–∞–Ω"
        fi
        
        if [ -f "stats.js" ]; then
          echo "‚úÖ stats.js —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
        else
          echo "‚ùå stats.js –Ω–µ —Å–æ–∑–¥–∞–Ω"
        fi
        
        # –ö–æ–º–º–∏—Ç–∏–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
        git add players_data.json stats.js
        if ! git diff --cached --quiet; then
          git commit -m "ü§ñ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –æ—Ç $(date '+%d.%m.%Y %H:%M')"
          git push
          echo "‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏—è –∑–∞–∫–æ–º–º–∏—á–µ–Ω—ã –∏ –∑–∞–ø—É—â–µ–Ω—ã"
        else
          echo "üì≠ –ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è –∫–æ–º–º–∏—Ç–∞"
        fi